<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/methods/core/cart.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FS.Store.GridFS.html">GridFS</a></li><li><a href="Products.html">Products</a><ul class='methods'><li data-type='method'><a href="Products.html#render">render</a></li><li data-type='method'><a href="Products.html#renderLoadMoreProductsButton">renderLoadMoreProductsButton</a></li><li data-type='method'><a href="Products.html#renderNotFound">renderNotFound</a></li><li data-type='method'><a href="Products.html#renderProductGrid">renderProductGrid</a></li><li data-type='method'><a href="Products.html#renderSpinner">renderSpinner</a></li></ul></li><li><a href="ReactiveAggregate.html">ReactiveAggregate</a></li><li><a href="Router.html">Router</a><ul class='members'><li data-type='member'><a href="Router.html#._routes">_routes</a></li><li data-type='member'><a href="Router.html#.triggers">triggers</a></li><li data-type='member'><a href="Router.html#_initialized">_initialized</a></li><li data-type='member'><a href="Router.html#activeClassName">activeClassName</a></li><li data-type='member'><a href="Router.html#history">history</a></li><li data-type='member'><a href="Router.html#Hooks">Hooks</a></li><li data-type='member'><a href="Router.html#routes">routes</a></li></ul><ul class='methods'><li data-type='method'><a href="Router.html#.current">current</a></li><li data-type='method'><a href="Router.html#.getParam">getParam</a></li><li data-type='method'><a href="Router.html#.getQueryParam">getQueryParam</a></li><li data-type='method'><a href="Router.html#.getRouteName">getRouteName</a></li><li data-type='method'><a href="Router.html#.go">go</a></li><li data-type='method'><a href="Router.html#.initPackageRoutes">initPackageRoutes</a></li><li data-type='method'><a href="Router.html#.isActiveClassName">isActiveClassName</a></li><li data-type='method'><a href="Router.html#.pathFor">pathFor</a></li><li data-type='method'><a href="Router.html#.ready">ready</a></li><li data-type='method'><a href="Router.html#.reload">reload</a></li><li data-type='method'><a href="Router.html#.replace">replace</a></li><li data-type='method'><a href="Router.html#.setCurrentRoute">setCurrentRoute</a></li><li data-type='method'><a href="Router.html#.setQueryParams">setQueryParams</a></li><li data-type='method'><a href="Router.html#.triggerRouterReady">triggerRouterReady</a></li><li data-type='method'><a href="Router.html#.watchPathChange">watchPathChange</a></li></ul></li><li><a href="Validation.html">Validation</a><ul class='methods'><li data-type='method'><a href="Validation.html#validate">validate</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-AddEmail.html">AddEmail</a><ul class='methods'><li data-type='method'><a href="module-AddEmail.html#~handleFieldChange()">handleFieldChange()</a></li><li data-type='method'><a href="module-AddEmail.html#~handleSubmit()">handleSubmit()</a></li></ul></li><li><a href="module-cartOrderTransform.html">cartOrderTransform</a><ul class='methods'><li data-type='method'><a href="module-cartOrderTransform.html#~cartCount">cartCount</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~cartDiscounts">cartDiscounts</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~cartShipping">cartShipping</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~cartSubtotal">cartSubtotal</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~cartTaxes">cartTaxes</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~cartTotal">cartTotal</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getCount">getCount</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getDiscounts">getDiscounts</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getDiscountsByShop">getDiscountsByShop</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getItemsByShop">getItemsByShop</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getPaymentMethods">getPaymentMethods</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getShippingTotal">getShippingTotal</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getShippingTotalByShop">getShippingTotalByShop</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getShopSummary">getShopSummary</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getSubTotal">getSubTotal</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getSubtotalByShop">getSubtotalByShop</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getTaxesByShop">getTaxesByShop</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getTaxTotal">getTaxTotal</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getTotal">getTotal</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getTotalByShop">getTotalByShop</a></li><li data-type='method'><a href="module-cartOrderTransform.html#~getUniquePaymentMethods">getUniquePaymentMethods</a></li></ul></li><li><a href="module-components.html">components</a><ul class='members'><li data-type='member'><a href="module-components.html#.getHOCs">getHOCs</a></li><li data-type='member'><a href="module-components.html#.getRawComponent">getRawComponent</a></li></ul><ul class='methods'><li data-type='method'><a href="module-components.html#.composeWithTracker">composeWithTracker</a></li><li data-type='method'><a href="module-components.html#.copyHOCs">copyHOCs</a></li><li data-type='method'><a href="module-components.html#.getComponent">getComponent</a></li><li data-type='method'><a href="module-components.html#.loadRegisteredComponents">loadRegisteredComponents</a></li><li data-type='method'><a href="module-components.html#.registerComponent">registerComponent</a></li><li data-type='method'><a href="module-components.html#.registerHOC">registerHOC</a></li><li data-type='method'><a href="module-components.html#.replaceComponent">replaceComponent</a></li><li data-type='method'><a href="module-components.html#.withCurrentAccount">withCurrentAccount</a></li><li data-type='method'><a href="module-components.html#.withCurrentUser">withCurrentUser</a></li><li data-type='method'><a href="module-components.html#.withIsAdmin">withIsAdmin</a></li><li data-type='method'><a href="module-components.html#.withIsOwner">withIsOwner</a></li><li data-type='method'><a href="module-components.html#.withPermissions">withPermissions</a></li><li data-type='method'><a href="module-components.html#~getTrackerLoader">getTrackerLoader</a></li></ul></li><li><a href="module-connectors-shopify.html">connectors-shopify</a><ul class='methods'><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/api/products/count">connectors/shopify/api/products/count</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/import/products">connectors/shopify/import/products</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/sync/orders/created">connectors/shopify/sync/orders/created</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/sync/setup">connectors/shopify/sync/setup</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/sync/teardown">connectors/shopify/sync/teardown</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/webhooks/create">connectors/shopify/webhooks/create</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/webhooks/delete">connectors/shopify/webhooks/delete</a></li><li data-type='method'><a href="module-connectors-shopify.html#~connectors/shopify/webhooks/deleteAll">connectors/shopify/webhooks/deleteAll</a></li></ul></li><li><a href="module-Invoice.html">Invoice</a><ul class='methods'><li data-type='method'><a href="module-Invoice.html#~formatDate()">formatDate()</a></li><li data-type='method'><a href="module-Invoice.html#~handleClick()">handleClick()</a></li><li data-type='method'><a href="module-Invoice.html#~renderConditionalDisplay()">renderConditionalDisplay()</a></li><li data-type='method'><a href="module-Invoice.html#~renderDiscountForm()">renderDiscountForm()</a></li><li data-type='method'><a href="module-Invoice.html#~renderInvoice()">renderInvoice()</a></li><li data-type='method'><a href="module-Invoice.html#~renderRefundsInfo()">renderRefundsInfo()</a></li><li data-type='method'><a href="module-Invoice.html#~renderTotal()">renderTotal()</a></li></ul></li><li><a href="module-InvoiceActions.html">InvoiceActions</a></li><li><a href="module-LineItems.html">LineItems</a></li><li><a href="module-OrderSearch.html">OrderSearch</a><ul class='methods'><li data-type='method'><a href="module-OrderSearch.html#~handleChange()">handleChange()</a></li><li data-type='method'><a href="module-OrderSearch.html#~handleClear()">handleClear()</a></li></ul></li><li><a href="module-ReactionAlerts.html">ReactionAlerts</a><ul class='methods'><li data-type='method'><a href="module-ReactionAlerts.html#~alert">alert</a></li></ul></li><li><a href="module-SortableTable.html">SortableTable</a></li><li><a href="module-Translations.html">Translations</a></li></ul><h3>Namespaces</h3><ul><li><a href="FS.TempStore.html">TempStore</a><ul class='methods'><li data-type='method'><a href="FS.TempStore.html#.createReadStream">createReadStream</a></li><li data-type='method'><a href="FS.TempStore.html#.createWriteStream">createWriteStream</a></li><li data-type='method'><a href="FS.TempStore.html#.exists">exists</a></li><li data-type='method'><a href="FS.TempStore.html#.listParts">listParts</a></li><li data-type='method'><a href="FS.TempStore.html#.removeAll">removeAll</a></li><li data-type='method'><a href="FS.TempStore.html#.removeFile">removeFile</a></li></ul></li><li><a href="Hooks.Events.html">Events</a><ul class='methods'><li data-type='method'><a href="Hooks.Events.html#.add">add</a></li><li data-type='method'><a href="Hooks.Events.html#.remove">remove</a></li><li data-type='method'><a href="Hooks.Events.html#.run">run</a></li><li data-type='method'><a href="Hooks.Events.html#.runAsync">runAsync</a></li></ul></li><li><a href="i18n.html">i18n</a><ul class='methods'><li data-type='method'><a href="i18n.html#.currencySymbol">currencySymbol</a></li><li data-type='method'><a href="i18n.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="i18n.html#.formatPrice">formatPrice</a></li><li data-type='method'><a href="i18n.html#.formatPriceString">formatPriceString</a></li><li data-type='method'><a href="i18n.html#.getBrowserLanguage">getBrowserLanguage</a></li><li data-type='method'><a href="i18n.html#.getLabelsFor">getLabelsFor</a></li><li data-type='method'><a href="i18n.html#.getMessagesFor">getMessagesFor</a></li><li data-type='method'><a href="i18n.html#.i18n">i18n</a></li></ul></li><li><a href="Meteor_Accounts.html">Meteor/Accounts</a><ul class='methods'><li data-type='method'><a href="Meteor_Accounts.html#.addressBookAdd">addressBookAdd</a></li><li data-type='method'><a href="Meteor_Accounts.html#.addressBookRemove">addressBookRemove</a></li><li data-type='method'><a href="Meteor_Accounts.html#.addressBookUpdate">addressBookUpdate</a></li><li data-type='method'><a href="Meteor_Accounts.html#.addUserPermissions">addUserPermissions</a></li><li data-type='method'><a href="Meteor_Accounts.html#.createFallbackLoginToken">createFallbackLoginToken</a></li><li data-type='method'><a href="Meteor_Accounts.html#.inviteShopMember">inviteShopMember</a></li><li data-type='method'><a href="Meteor_Accounts.html#.inviteShopOwner">inviteShopOwner</a></li><li data-type='method'><a href="Meteor_Accounts.html#.removeEmailAddress">removeEmailAddress</a></li><li data-type='method'><a href="Meteor_Accounts.html#.removeUserPermissions">removeUserPermissions</a></li><li data-type='method'><a href="Meteor_Accounts.html#.sendResetPasswordEmail">sendResetPasswordEmail</a></li><li data-type='method'><a href="Meteor_Accounts.html#.sendWelcomeEmail">sendWelcomeEmail</a></li><li data-type='method'><a href="Meteor_Accounts.html#.setUserPermissions">setUserPermissions</a></li><li data-type='method'><a href="Meteor_Accounts.html#.syncUsersAndAccounts">syncUsersAndAccounts</a></li><li data-type='method'><a href="Meteor_Accounts.html#.updateEmailAddress">updateEmailAddress</a></li><li data-type='method'><a href="Meteor_Accounts.html#.updateServiceConfiguration">updateServiceConfiguration</a></li><li data-type='method'><a href="Meteor_Accounts.html#.validateAddress">validateAddress</a></li><li data-type='method'><a href="Meteor_Accounts.html#.verifyAccount">verifyAccount</a></li></ul></li><li><a href="Meteor_Accounts_Validation.html">Meteor/Accounts/Validation</a><ul class='methods'><li data-type='method'><a href="Meteor_Accounts_Validation.html#.email">email</a></li><li data-type='method'><a href="Meteor_Accounts_Validation.html#.password">password</a></li><li data-type='method'><a href="Meteor_Accounts_Validation.html#.username">username</a></li></ul></li><li><a href="Meteor_Cart.html">Meteor/Cart</a><ul class='methods'><li data-type='method'><a href="Meteor_Cart.html#.cart/addToCart">cart/addToCart</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/createCart">cart/createCart</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/mergeCart">cart/mergeCart</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/removeFromCart">cart/removeFromCart</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/resetShipmentMethod">cart/resetShipmentMethod</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/setAnonymousUserEmail">cart/setAnonymousUserEmail</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/setPaymentAddress">cart/setPaymentAddress</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/setShipmentAddress">cart/setShipmentAddress</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/setShipmentMethod">cart/setShipmentMethod</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/setUserCurrency">cart/setUserCurrency</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/submitPayment">cart/submitPayment</a></li><li data-type='method'><a href="Meteor_Cart.html#.cart/unsetAddresses">cart/unsetAddresses</a></li></ul></li><li><a href="Meteor_Email.html">Meteor/Email</a><ul class='methods'><li data-type='method'><a href="Meteor_Email.html#.retryFailed">retryFailed</a></li><li data-type='method'><a href="Meteor_Email.html#.saveSettings">saveSettings</a></li><li data-type='method'><a href="Meteor_Email.html#.verifySettings">verifySettings</a></li></ul></li><li><a href="Meteor_Group.html">Meteor/Group</a><ul class='methods'><li data-type='method'><a href="Meteor_Group.html#.group/addUser">group/addUser</a></li><li data-type='method'><a href="Meteor_Group.html#.group/createGroup">group/createGroup</a></li><li data-type='method'><a href="Meteor_Group.html#.group/removeUser">group/removeUser</a></li><li data-type='method'><a href="Meteor_Group.html#.group/updateGroup">group/updateGroup</a></li></ul></li><li><a href="Meteor_i18n.html">Meteor/i18n</a><ul class='methods'><li data-type='method'><a href="Meteor_i18n.html#.addTranslation">addTranslation</a></li><li data-type='method'><a href="Meteor_i18n.html#.flushTranslations">flushTranslations</a></li></ul></li><li><a href="Meteor_Inventory.html">Meteor/Inventory</a><ul class='methods'><li data-type='method'><a href="Meteor_Inventory.html#.backorder">backorder</a></li><li data-type='method'><a href="Meteor_Inventory.html#.clearReserve">clearReserve</a></li><li data-type='method'><a href="Meteor_Inventory.html#.clearReserve">clearReserve</a></li><li data-type='method'><a href="Meteor_Inventory.html#.clearStatus">clearStatus</a></li><li data-type='method'><a href="Meteor_Inventory.html#.lowStock">lowStock</a></li><li data-type='method'><a href="Meteor_Inventory.html#.remove">remove</a></li><li data-type='method'><a href="Meteor_Inventory.html#.return">return</a></li><li data-type='method'><a href="Meteor_Inventory.html#.returnToStock">returnToStock</a></li><li data-type='method'><a href="Meteor_Inventory.html#.setStatus">setStatus</a></li><li data-type='method'><a href="Meteor_Inventory.html#.shipped">shipped</a></li><li data-type='method'><a href="Meteor_Inventory.html#.sold">sold</a></li></ul></li><li><a href="Meteor_Notification.html">Meteor/Notification</a><ul class='methods'><li data-type='method'><a href="Meteor_Notification.html#.delete">delete</a></li><li data-type='method'><a href="Meteor_Notification.html#.markOneAsRead">markOneAsRead</a></li><li data-type='method'><a href="Meteor_Notification.html#.send">send</a></li></ul></li><li><a href="Meteor_Product.html">Meteor/Product</a><ul class='methods'><li data-type='method'><a href="Meteor_Product.html#.archiveProduct">archiveProduct</a></li><li data-type='method'><a href="Meteor_Product.html#.cloneProduct">cloneProduct</a></li><li data-type='method'><a href="Meteor_Product.html#.cloneVariant">cloneVariant</a></li><li data-type='method'><a href="Meteor_Product.html#.createProduct">createProduct</a></li><li data-type='method'><a href="Meteor_Product.html#.createVariant">createVariant</a></li><li data-type='method'><a href="Meteor_Product.html#.deleteVariant">deleteVariant</a></li><li data-type='method'><a href="Meteor_Product.html#.publishProduct">publishProduct</a></li><li data-type='method'><a href="Meteor_Product.html#.removeMetaFields">removeMetaFields</a></li><li data-type='method'><a href="Meteor_Product.html#.removeProductTag">removeProductTag</a></li><li data-type='method'><a href="Meteor_Product.html#.setHandle">setHandle</a></li><li data-type='method'><a href="Meteor_Product.html#.setHandleTag">setHandleTag</a></li><li data-type='method'><a href="Meteor_Product.html#.toggleVisibility">toggleVisibility</a></li><li data-type='method'><a href="Meteor_Product.html#.updateMetaFields">updateMetaFields</a></li><li data-type='method'><a href="Meteor_Product.html#.updateProductField">updateProductField</a></li><li data-type='method'><a href="Meteor_Product.html#.updateProductPosition">updateProductPosition</a></li><li data-type='method'><a href="Meteor_Product.html#.updateProductTags">updateProductTags</a></li><li data-type='method'><a href="Meteor_Product.html#.updateVariant">updateVariant</a></li><li data-type='method'><a href="Meteor_Product.html#.updateVariantsPosition">updateVariantsPosition</a></li></ul></li><li><a href="Meteor_Reaction.html">Meteor/Reaction</a><ul class='methods'><li data-type='method'><a href="Meteor_Reaction.html#.getUserId">getUserId</a></li></ul></li><li><a href="Meteor_Shop.html">Meteor/Shop</a><ul class='methods'><li data-type='method'><a href="Meteor_Shop.html#.changeLayout">changeLayout</a></li><li data-type='method'><a href="Meteor_Shop.html#.createShop">createShop</a></li><li data-type='method'><a href="Meteor_Shop.html#.createTag">createTag</a></li><li data-type='method'><a href="Meteor_Shop.html#.fetchCurrencyRate">fetchCurrencyRate</a></li><li data-type='method'><a href="Meteor_Shop.html#.flushCurrencyRate">flushCurrencyRate</a></li><li data-type='method'><a href="Meteor_Shop.html#.getCurrencyRates">getCurrencyRates</a></li><li data-type='method'><a href="Meteor_Shop.html#.getLocale">getLocale</a></li><li data-type='method'><a href="Meteor_Shop.html#.getWorkflow">getWorkflow</a></li><li data-type='method'><a href="Meteor_Shop.html#.hideHeaderTag">hideHeaderTag</a></li><li data-type='method'><a href="Meteor_Shop.html#.locateAddress">locateAddress</a></li><li data-type='method'><a href="Meteor_Shop.html#.removeHeaderTag">removeHeaderTag</a></li><li data-type='method'><a href="Meteor_Shop.html#.togglePackage">togglePackage</a></li><li data-type='method'><a href="Meteor_Shop.html#.updateBrandAsset">updateBrandAsset</a></li><li data-type='method'><a href="Meteor_Shop.html#.updateCurrencyConfiguration">updateCurrencyConfiguration</a></li><li data-type='method'><a href="Meteor_Shop.html#.updateHeaderTags">updateHeaderTags</a></li><li data-type='method'><a href="Meteor_Shop.html#.updateLanguageConfiguration">updateLanguageConfiguration</a></li><li data-type='method'><a href="Meteor_Shop.html#.updateShopExternalServices">updateShopExternalServices</a></li></ul></li><li><a href="Meteor_SMS.html">Meteor/SMS</a><ul class='methods'><li data-type='method'><a href="Meteor_SMS.html#.saveSettings">saveSettings</a></li><li data-type='method'><a href="Meteor_SMS.html#.send">send</a></li></ul></li><li><a href="Meteor_Workflow.html">Meteor/Workflow</a><ul class='methods'><li data-type='method'><a href="Meteor_Workflow.html#.coreOrderWorkflow/coreOrderCompleted">coreOrderWorkflow/coreOrderCompleted</a></li><li data-type='method'><a href="Meteor_Workflow.html#.coreOrderWorkflow/coreOrderProcessing">coreOrderWorkflow/coreOrderProcessing</a></li><li data-type='method'><a href="Meteor_Workflow.html#.pullOrderWorkflow">pullOrderWorkflow</a></li><li data-type='method'><a href="Meteor_Workflow.html#.pushCartWorkflow">pushCartWorkflow</a></li><li data-type='method'><a href="Meteor_Workflow.html#.pushItemWorkflow">pushItemWorkflow</a></li><li data-type='method'><a href="Meteor_Workflow.html#.pushOrderWorkflow">pushOrderWorkflow</a></li><li data-type='method'><a href="Meteor_Workflow.html#.revertCartWorkflow">revertCartWorkflow</a></li></ul></li><li><a href="schemas.html">schemas</a><ul class='members'><li data-type='member'><a href="schemas.html#.Accounts">Accounts</a></li><li data-type='member'><a href="schemas.html#.Address">Address</a></li><li data-type='member'><a href="schemas.html#.AnalyticsEvents">AnalyticsEvents</a></li><li data-type='member'><a href="schemas.html#.Assets">Assets</a></li><li data-type='member'><a href="schemas.html#.BrandAsset">BrandAsset</a></li><li data-type='member'><a href="schemas.html#.Cart">Cart</a></li><li data-type='member'><a href="schemas.html#.CartItem">CartItem</a></li><li data-type='member'><a href="schemas.html#.CartItems">CartItems</a></li><li data-type='member'><a href="schemas.html#.CorePackageConfig">CorePackageConfig</a></li><li data-type='member'><a href="schemas.html#.Currency">Currency</a></li><li data-type='member'><a href="schemas.html#.Currency">Currency</a></li><li data-type='member'><a href="schemas.html#.CustomEmailSettings">CustomEmailSettings</a></li><li data-type='member'><a href="schemas.html#.Document">Document</a></li><li data-type='member'><a href="schemas.html#.Email">Email</a></li><li data-type='member'><a href="schemas.html#.Emails">Emails</a></li><li data-type='member'><a href="schemas.html#.EventforEventLog">Event for EventLog</a></li><li data-type='member'><a href="schemas.html#.Group">Group</a></li><li data-type='member'><a href="schemas.html#.History">History</a></li><li data-type='member'><a href="schemas.html#.Inventory">Inventory</a></li><li data-type='member'><a href="schemas.html#.Invoice">Invoice</a></li><li data-type='member'><a href="schemas.html#.Languages">Languages</a></li><li data-type='member'><a href="schemas.html#.LayoutStructure">LayoutStructure</a></li><li data-type='member'><a href="schemas.html#.Locale">Locale</a></li><li data-type='member'><a href="schemas.html#.Logs">Logs</a></li><li data-type='member'><a href="schemas.html#.MerchantShop">MerchantShop</a></li><li data-type='member'><a href="schemas.html#.Metafield">Metafield</a></li><li data-type='member'><a href="schemas.html#.Notes">Notes</a></li><li data-type='member'><a href="schemas.html#.Notification">Notification</a></li><li data-type='member'><a href="schemas.html#.OrderSchema">Order Schema</a></li><li data-type='member'><a href="schemas.html#.OrderItems">OrderItems</a></li><li data-type='member'><a href="schemas.html#.OrderTransactionSchema">OrderTransaction Schema</a></li><li data-type='member'><a href="schemas.html#.PackageConfig">PackageConfig</a></li><li data-type='member'><a href="schemas.html#.Payment">Payment</a></li><li data-type='member'><a href="schemas.html#.Payment">Payment</a></li><li data-type='member'><a href="schemas.html#.PaymentItem">PaymentItem</a></li><li data-type='member'><a href="schemas.html#.PaymentMethod">PaymentMethod</a></li><li data-type='member'><a href="schemas.html#.Permissions">Permissions</a></li><li data-type='member'><a href="schemas.html#.PriceRange">PriceRange</a></li><li data-type='member'><a href="schemas.html#.Product">Product</a></li><li data-type='member'><a href="schemas.html#.ProductPosition">ProductPosition</a></li><li data-type='member'><a href="schemas.html#.ProductVariant">ProductVariant</a></li><li data-type='member'><a href="schemas.html#.Profile">Profile</a></li><li data-type='member'><a href="schemas.html#.ReactionAnalyticsPackageConfig">ReactionAnalyticsPackageConfig</a></li><li data-type='member'><a href="schemas.html#.ReactLayout">ReactLayout</a></li><li data-type='member'><a href="schemas.html#.Registry">Registry</a></li><li data-type='member'><a href="schemas.html#.Revisions">Revisions</a></li><li data-type='member'><a href="schemas.html#.sharedFields">sharedFields</a></li><li data-type='member'><a href="schemas.html#.Shipment">Shipment</a></li><li data-type='member'><a href="schemas.html#.ShipmentItem">ShipmentItem</a></li><li data-type='member'><a href="schemas.html#.ShipmentQuote">ShipmentQuote</a></li><li data-type='member'><a href="schemas.html#.ShipmentQuotesQueryStatusUsed">ShipmentQuotesQueryStatusUsed</a></li><li data-type='member'><a href="schemas.html#.Shipping">Shipping</a></li><li data-type='member'><a href="schemas.html#.ShippingMethod">ShippingMethod</a></li><li data-type='member'><a href="schemas.html#.ShippingPackage">ShippingPackage</a></li><li data-type='member'><a href="schemas.html#.ShippingParcel">ShippingParcel</a></li><li data-type='member'><a href="schemas.html#.ShippingProvider">ShippingProvider</a></li><li data-type='member'><a href="schemas.html#.ShippoShipment">ShippoShipment</a></li><li data-type='member'><a href="schemas.html#.ShippoShippingMethod">ShippoShippingMethod</a></li><li data-type='member'><a href="schemas.html#.ShippoShippingProviderSchema">ShippoShippingProvider Schema</a></li><li data-type='member'><a href="schemas.html#.Shop">Shop</a></li><li data-type='member'><a href="schemas.html#.ShopTheme">ShopTheme</a></li><li data-type='member'><a href="schemas.html#.Sms">Sms</a></li><li data-type='member'><a href="schemas.html#.SocialPackageConfig">SocialPackageConfig</a></li><li data-type='member'><a href="schemas.html#.SocialProvider">SocialProvider</a></li><li data-type='member'><a href="schemas.html#.Tag">Tag</a></li><li data-type='member'><a href="schemas.html#.TaxSettings">TaxSettings</a></li><li data-type='member'><a href="schemas.html#.Template">Template</a></li><li data-type='member'><a href="schemas.html#.Themes">Themes</a></li><li data-type='member'><a href="schemas.html#.Translation">Translation</a></li><li data-type='member'><a href="schemas.html#.VariantMedia">VariantMedia</a></li><li data-type='member'><a href="schemas.html#.Workflow">Workflow</a></li></ul><ul class='methods'><li data-type='method'><a href="schemas.html#.schemaIdAutoValue">schemaIdAutoValue</a></li><li data-type='method'><a href="schemas.html#.shopDefaultCountry">shopDefaultCountry</a></li><li data-type='method'><a href="schemas.html#.shopIdAutoValue">shopIdAutoValue</a></li><li data-type='method'><a href="schemas.html#.shopIdAutoValueForCart">shopIdAutoValueForCart</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#%2522changeinput.checkbox-switch.connector-settings%255Bname=enabled%255D%2522">"change input.checkbox-switch.connector-settings[name=enabled]"</a></li><li><a href="global.html#%2522changeinput.checkbox-switch.shipping-settings%255Bname=enabled%255D%2522">"change input.checkbox-switch.shipping-settings[name=enabled]"</a></li><li><a href="global.html#%2522changeinput%255Bname=enabled%255D%2522">"change input[name=enabled]"</a></li><li><a href="global.html#%2522click.js-paypal-express-checkout%2522">"click .js-paypal-express-checkout"</a></li><li><a href="global.html#%2522click%255Bdata-event-action=cancelOrder%255D%2522">"click [data-event-action=cancelOrder]"</a></li><li><a href="global.html#%2522click%255Bdata-event-action=showSecret%255D%2522">"click [data-event-action=showSecret]"</a></li><li><a href="global.html#%2522example/payment/capture%2522">"example/payment/capture"</a></li><li><a href="global.html#%2522example/refund/create%2522">"example/refund/create"</a></li><li><a href="global.html#%2522example/refund/list%2522">"example/refund/list"</a></li><li><a href="global.html#%2522submitform%2522">"submit form"</a></li><li><a href="global.html#%2522taxcloud/getTaxCodes%2522">"taxcloud/getTaxCodes"</a></li><li><a href="global.html#addBodyClasses">addBodyClasses</a></li><li><a href="global.html#addRolesToGroups">addRolesToGroups</a></li><li><a href="global.html#addTag">addTag</a></li><li><a href="global.html#approvePayment">approvePayment</a></li><li><a href="global.html#assignOwnerRoles">assignOwnerRoles</a></li><li><a href="global.html#AuthNetPackageConfig">AuthNetPackageConfig</a></li><li><a href="global.html#avaGet">avaGet</a></li><li><a href="global.html#AvalaraPackageConfig">AvalaraPackageConfig</a></li><li><a href="global.html#avaPost">avaPost</a></li><li><a href="global.html#baseOrder">baseOrder</a></li><li><a href="global.html#BraintreePackageConfig">BraintreePackageConfig</a></li><li><a href="global.html#capturePayments">capturePayments</a></li><li><a href="global.html#cardProps">cardProps</a></li><li><a href="global.html#cartShipmentMethods">cartShipmentMethods</a></li><li><a href="global.html#cartShippingQuotes">cartShippingQuotes</a></li><li><a href="global.html#cartToSalesOrder">cartToSalesOrder</a></li><li><a href="global.html#checkConfiguration">checkConfiguration</a></li><li><a href="global.html#checked">checked</a></li><li><a href="global.html#checkout">checkout</a></li><li><a href="global.html#cleanupAvalaraJobs">cleanupAvalaraJobs</a></li><li><a href="global.html#collectDropSource">collectDropSource</a></li><li><a href="global.html#compileHandlebarsTemplate">compileHandlebarsTemplate</a></li><li><a href="global.html#CompletedOrder">CompletedOrder</a></li><li><a href="global.html#CompletedOrderItem">CompletedOrderItem</a></li><li><a href="global.html#CompletedOrderPaymentMethod">CompletedOrderPaymentMethod</a></li><li><a href="global.html#CompletedOrderSummary">CompletedOrderSummary</a></li><li><a href="global.html#CompletedShopOrders">CompletedShopOrders</a></li><li><a href="global.html#copyCartToOrder">copyCartToOrder</a></li><li><a href="global.html#Countries">Countries</a></li><li><a href="global.html#createCountryCollection">createCountryCollection</a></li><li><a href="global.html#createRefund">createRefund</a></li><li><a href="global.html#DEFAULT_FILTER_NAME">DEFAULT_FILTER_NAME</a></li><li><a href="global.html#DEFAULT_LAYOUT">DEFAULT_LAYOUT</a></li><li><a href="global.html#DiscountCodes">DiscountCodes</a></li><li><a href="global.html#DiscountCodesPackageConfig">DiscountCodesPackageConfig</a></li><li><a href="global.html#DiscountRates">DiscountRates</a></li><li><a href="global.html#DiscountRatesPackageConfig">DiscountRatesPackageConfig</a></li><li><a href="global.html#Discounts">Discounts</a></li><li><a href="global.html#DiscountsPackageConfig">DiscountsPackageConfig</a></li><li><a href="global.html#displayEmail">displayEmail</a></li><li><a href="global.html#displayName">displayName</a></li><li><a href="global.html#doesUserExist">doesUserExist</a></li><li><a href="global.html#doRightJoinNoIntersection">doRightJoinNoIntersection</a></li><li><a href="global.html#EditButton">EditButton</a></li><li><a href="global.html#EmailTemplates">EmailTemplates</a></li><li><a href="global.html#exampleSubmit">exampleSubmit</a></li><li><a href="global.html#expressCheckoutSettingsValid">expressCheckoutSettingsValid</a></li><li><a href="global.html#filterShippingStatus">filterShippingStatus</a></li><li><a href="global.html#filterWorkflowStatus">filterWorkflowStatus</a></li><li><a href="global.html#findProductMedia">findProductMedia</a></li><li><a href="global.html#fulfillmentNumber">fulfillmentNumber</a></li><li><a href="global.html#GeoCoder">GeoCoder</a></li><li><a href="global.html#getAbsoluteUrl">getAbsoluteUrl</a></li><li><a href="global.html#getAuthData">getAuthData</a></li><li><a href="global.html#getBillingInfo">getBillingInfo</a></li><li><a href="global.html#getCardType">getCardType</a></li><li><a href="global.html#getCartItem">getCartItem</a></li><li><a href="global.html#getCurrentShop">getCurrentShop</a></li><li><a href="global.html#getCurrentShopCursor">getCurrentShopCursor</a></li><li><a href="global.html#getCurrentTag">getCurrentTag</a></li><li><a href="global.html#getGuestLoginState">getGuestLoginState</a></li><li><a href="global.html#getInvitableGroups">getInvitableGroups</a></li><li><a href="global.html#getMailConfig">getMailConfig</a></li><li><a href="global.html#getMailUrl">getMailUrl</a></li><li><a href="global.html#getMarketplaceSettings">getMarketplaceSettings</a></li><li><a href="global.html#getMarketplaceSettingsFromPackages">getMarketplaceSettingsFromPackages</a></li><li><a href="global.html#getPackageSettingsWithOptions">getPackageSettingsWithOptions</a></li><li><a href="global.html#getPublishedOrRevision">getPublishedOrRevision</a></li><li><a href="global.html#getRegistryDomain">getRegistryDomain</a></li><li><a href="global.html#getRegistryRouteName">getRegistryRouteName</a></li><li><a href="global.html#getRouteName">getRouteName</a></li><li><a href="global.html#getSchemas">getSchemas</a></li><li><a href="global.html#getSellerShop">getSellerShop</a></li><li><a href="global.html#getSellerShopId">getSellerShopId</a></li><li><a href="global.html#getShippingInfo">getShippingInfo</a></li><li><a href="global.html#getShippingRates">getShippingRates</a></li><li><a href="global.html#getShopId">getShopId</a></li><li><a href="global.html#getShopName">getShopName</a></li><li><a href="global.html#getShopPrefix">getShopPrefix</a></li><li><a href="global.html#getShopsWithRoles">getShopsWithRoles</a></li><li><a href="global.html#getSiblings">getSiblings</a></li><li><a href="global.html#getSlug">getSlug</a></li><li><a href="global.html#getstaleCarts">getstaleCarts</a></li><li><a href="global.html#getSubject">getSubject</a></li><li><a href="global.html#getTargetAccount">getTargetAccount</a></li><li><a href="global.html#getTaxSettings">getTaxSettings</a></li><li><a href="global.html#getTemplate">getTemplate</a></li><li><a href="global.html#getTemplateFile">getTemplateFile</a></li><li><a href="global.html#getTopVariants">getTopVariants</a></li><li><a href="global.html#getUrl">getUrl</a></li><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#getVariantParent">getVariantParent</a></li><li><a href="global.html#getVariants">getVariants</a></li><li><a href="global.html#GroupsTableButton">GroupsTableButton</a></li><li><a href="global.html#Handle">Handle</a></li><li><a href="global.html#handleEmailSubmit">handleEmailSubmit</a></li><li><a href="global.html#handleFieldChange">handleFieldChange</a></li><li><a href="global.html#handleOpenShortcut">handleOpenShortcut</a></li><li><a href="global.html#handleShopSelectChange">handleShopSelectChange</a></li><li><a href="global.html#handleShowDashboard">handleShowDashboard</a></li><li><a href="global.html#handleShowPackage">handleShowPackage</a></li><li><a href="global.html#hasAdminAccess">hasAdminAccess</a></li><li><a href="global.html#Hook">Hook</a></li><li><a href="global.html#Hooks">Hooks</a></li><li><a href="global.html#isAdmin">isAdmin</a></li><li><a href="global.html#isCompleted">isCompleted</a></li><li><a href="global.html#isConfigured">isConfigured</a></li><li><a href="global.html#isCustomValue">isCustomValue</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isOwnerOfProfile">isOwnerOfProfile</a></li><li><a href="global.html#isPackageEnabled">isPackageEnabled</a></li><li><a href="global.html#isPending">isPending</a></li><li><a href="global.html#isShopGuest">isShopGuest</a></li><li><a href="global.html#isShopMember">isShopMember</a></li><li><a href="global.html#Jobs">Jobs</a></li><li><a href="global.html#label">label</a></li><li><a href="global.html#listRefunds">listRefunds</a></li><li><a href="global.html#loadCoreTranslations">loadCoreTranslations</a></li><li><a href="global.html#loadMoreProducts">loadMoreProducts</a></li><li><a href="global.html#loadSettings">loadSettings</a></li><li><a href="global.html#loadTranslation">loadTranslation</a></li><li><a href="global.html#loadTranslations">loadTranslations</a></li><li><a href="global.html#Logs">Logs</a></li><li><a href="global.html#Media">Media</a></li><li><a href="global.html#members">members</a></li><li><a href="global.html#mergeDeep">mergeDeep</a></li><li><a href="global.html#MetaData">MetaData</a></li><li><a href="global.html#metaField">metaField</a></li><li><a href="global.html#methods">methods</a></li><li><a href="global.html#normalizeAddresses">normalizeAddresses</a></li><li><a href="global.html#normalizeMode">normalizeMode</a></li><li><a href="global.html#normalizeStatus">normalizeStatus</a></li><li><a href="global.html#NotFound">NotFound</a></li><li><a href="global.html#Notifications">Notifications</a></li><li><a href="global.html#onCalculateStripeApplicationFee">onCalculateStripeApplicationFee</a></li><li><a href="global.html#order">order</a></li><li><a href="global.html#ORDER_LIST_FILTERS_PREFERENCE_NAME">ORDER_LIST_FILTERS_PREFERENCE_NAME</a></li><li><a href="global.html#ORDER_LIST_SELECTED_ORDER_PREFERENCE_NAME">ORDER_LIST_SELECTED_ORDER_PREFERENCE_NAME</a></li><li><a href="global.html#orderCreditMethod">orderCreditMethod</a></li><li><a href="global.html#orderFulfillmentData">orderFulfillmentData</a></li><li><a href="global.html#ordersInventoryAdjust">ordersInventoryAdjust</a></li><li><a href="global.html#ordersInventoryAdjustByShop">ordersInventoryAdjustByShop</a></li><li><a href="global.html#orderToSalesInvoice">orderToSalesInvoice</a></li><li><a href="global.html#PACKAGE_NAME">PACKAGE_NAME</a></li><li><a href="global.html#parseError">parseError</a></li><li><a href="global.html#parseRefundReponse">parseRefundReponse</a></li><li><a href="global.html#paymentCapture">paymentCapture</a></li><li><a href="global.html#paymentSubmit">paymentSubmit</a></li><li><a href="global.html#pkgPermissions">pkgPermissions</a></li><li><a href="global.html#productVariant">productVariant</a></li><li><a href="global.html#randomProcessor">randomProcessor</a></li><li><a href="global.html#Reaction">Reaction</a></li><li><a href="global.html#ReactionAvatar">ReactionAvatar</a></li><li><a href="global.html#ReactionLayout">ReactionLayout</a></li><li><a href="global.html#ReactionProduct">ReactionProduct</a></li><li><a href="global.html#registerInventory">registerInventory</a></li><li><a href="global.html#registerSchema">registerSchema</a></li><li><a href="global.html#registry">registry</a></li><li><a href="global.html#removeMedia">removeMedia</a></li><li><a href="global.html#resetRegisteredTemplates">resetRegisteredTemplates</a></li><li><a href="global.html#SellerShop">SellerShop</a></li><li><a href="global.html#send">send</a></li><li><a href="global.html#sendResetPasswordEmail">sendResetPasswordEmail</a></li><li><a href="global.html#sendUpdatedVerificationEmail">sendUpdatedVerificationEmail</a></li><li><a href="global.html#sendVerificationEmail">sendVerificationEmail</a></li><li><a href="global.html#ServerSessions">ServerSessions</a></li><li><a href="global.html#services">services</a></li><li><a href="global.html#shippingStates">shippingStates</a></li><li><a href="global.html#shippingStatus">shippingStatus</a></li><li><a href="global.html#ShopOrderSummary">ShopOrderSummary</a></li><li><a href="global.html#Shops">Shops</a></li><li><a href="global.html#showAvalaraTaxSettings">showAvalaraTaxSettings</a></li><li><a href="global.html#showMerchantSignup">showMerchantSignup</a></li><li><a href="global.html#shown">shown</a></li><li><a href="global.html#showVariant">showVariant</a></li><li><a href="global.html#Sms">Sms</a></li><li><a href="global.html#stripeCaptureCharge">stripeCaptureCharge</a></li><li><a href="global.html#TagHelpers">TagHelpers</a></li><li><a href="global.html#TaxCloudPackageConfig">TaxCloudPackageConfig</a></li><li><a href="global.html#TaxCodes">TaxCodes</a></li><li><a href="global.html#TaxEntityCodes">TaxEntityCodes</a></li><li><a href="global.html#Taxes">Taxes</a></li><li><a href="global.html#TaxJarPackageConfig">TaxJarPackageConfig</a></li><li><a href="global.html#TaxPackageConfig">TaxPackageConfig</a></li><li><a href="global.html#TaxRates">TaxRates</a></li><li><a href="global.html#Templates">Templates</a></li><li><a href="global.html#Themes">Themes</a></li><li><a href="global.html#thisApp">thisApp</a></li><li><a href="global.html#toCamelCase">toCamelCase</a></li><li><a href="global.html#toggleSession">toggleSession</a></li><li><a href="global.html#ToolbarGroup">ToolbarGroup</a></li><li><a href="global.html#ToolbarText">ToolbarText</a></li><li><a href="global.html#transform">transform</a></li><li><a href="global.html#translateRegistry">translateRegistry</a></li><li><a href="global.html#Translations">Translations</a></li><li><a href="global.html#UpdateEmail">UpdateEmail</a></li><li><a href="global.html#updateInventoryPolicyIfChildVariants">updateInventoryPolicyIfChildVariants</a></li><li><a href="global.html#updateMediaPriorities">updateMediaPriorities</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#userHasPassword">userHasPassword</a></li><li><a href="global.html#userOrders">userOrders</a></li><li><a href="global.html#valueForField">valueForField</a></li><li><a href="global.html#verifyConfig">verifyConfig</a></li><li><a href="global.html#VisibilityButton">VisibilityButton</a></li><li><a href="global.html#workflowStatus">workflowStatus</a></li><li><a href="global.html#writeJsonToBody">writeJsonToBody</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/methods/core/cart.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import _ from "lodash";
import { Meteor } from "meteor/meteor";
import { check, Match } from "meteor/check";
import { Roles } from "meteor/alanning:roles";
import { Random } from "meteor/random";
import * as Collections from "/lib/collections";
import { Logger, Reaction } from "/server/api";

/**
 * @method quantityProcessing
 * @private
 * @summary perform calculations admissibility of adding product to cart
 * @param {Object} product - product to add to Cart
 * @param {Object} variant - product variant
 * @param {Number} itemQty - qty to add to cart, defaults to 1, deducts
 *  from inventory
 * @since 1.10.1
 * @return {Number} quantity - revised quantity to be added to cart
 */
function quantityProcessing(product, variant, itemQty = 1) {
  let quantity = itemQty;
  const MIN = variant.minOrderQuantity || 1;
  const MAX = variant.inventoryQuantity || Infinity;

  if (variant.inventoryPolicy &amp;&amp; MIN > MAX) {
    Logger.debug(`productId: ${product._id}, variantId ${variant._id
    }: inventoryQuantity lower then minimum order`);
    throw new Meteor.Error(`productId: ${product._id}, variantId ${variant._id
    }: inventoryQuantity lower then minimum order`);
  }

  // TODO: think about #152 implementation here
  switch (product.type) {
    case "not-in-stock":
      break;
    default: // type: `simple` // todo: maybe it should be "variant"
      if (quantity &lt; MIN) {
        quantity = MIN;
      } else if (variant.inventoryPolicy &amp;&amp; quantity > MAX) {
        quantity = MAX;
      }
  }

  return quantity;
}

/**
 * @method getSessionCarts
 * @private
 * @summary get Cart cursor with all session carts
 * @param {String} userId - current user _id
 * @param {String} sessionId - current user session id
 * @param {String} shopId - shop id
 * @since 0.10.2
 * @return {Mongo.Cursor} with array of session carts
 */
function getSessionCarts(userId, sessionId, shopId) {
  const carts = Collections.Cart.find({
    $and: [{
      userId: {
        $ne: userId
      }
    }, {
      sessionId: {
        $eq: sessionId
      }
    }, {
      shopId: {
        $eq: shopId
      }
    }]
  });

  // we can't use Array.map here, because we need to reduce the number of array
  // elements if element belongs to registered user, we should throw it.
  const allowedCarts = [];

  // only anonymous user carts allowed
  carts.forEach(cart => {
    if (Roles.userIsInRole(cart.userId, "anonymous", shopId)) {
      allowedCarts.push(cart);
    }
  });

  return allowedCarts;
}

function removeShippingAddresses(cart) {
  const cartShipping = cart.shipping;
  cartShipping.map((sRecord) => {
    delete sRecord.address;
  });
  Collections.Cart.update({
    _id: cart._id
  }, {
    $set: { shipping: cartShipping }
  });
}

/**
 * @file Meteor for Cart
 *
 * @namespace Meteor/Cart
*/

Meteor.methods({
  /**
   * @method cart/mergeCart
   * @summary Merge matching sessionId cart into specified userId cart
   * @description There should be one cart for each independent, non-logged-in user session.
   * When a user logs in that cart now belongs to that user and we use the a single user cart.
   * If they are logged in on more than one devices, regardless of session,the user cart will be used
   * If they had more than one cart, on more than one device,logged in at separate times then merge the carts
   * @memberof Meteor/Cart
   * @param {String} cartId - cartId of the cart to merge matching session carts into.
   * @param {String} [currentSessionId] - current client session id
   * @todo I think this method should be moved out from methods to a Function Declaration to keep it more secure
   * @return {Object|Boolean} cartId - cartId on success or false
   */
  "cart/mergeCart": function (cartId, currentSessionId) {
    check(cartId, String);
    // TODO: Review this. currentSessionId sometimes come in as false. e.g from Accounts.onLogin
    check(currentSessionId, Match.Optional(String));

    // we don't process current cart, but merge into it.
    const currentCart = Collections.Cart.findOne(cartId);
    if (!currentCart) {
      throw new Meteor.Error("access-denied", "Access Denied");
    }
    // just used to filter out the current cart
    // we do additional check of cart exists here and if it not exist, next
    // check supposed to throw 403 error
    const userId = currentCart &amp;&amp; currentCart.userId;
    // user should have an access to operate with only one - his - cart
    if (this.userId !== null &amp;&amp; userId !== this.userId) {
      throw new Meteor.Error(403, "Access Denied");
    }
    // persistent sessions, see: publications/sessions.js
    // this is the last place where we still need `Reaction.sessionId`.
    // The use case is: on user log in. I don't know how pass `sessionId` down
    // at that moment.
    const sessionId = currentSessionId || Reaction.sessionId;
    const shopId = Reaction.getShopId();

    // no need to merge anonymous carts
    if (Roles.userIsInRole(userId, "anonymous", shopId)) {
      return false;
    }
    Logger.debug("merge cart: matching sessionId");
    Logger.debug("current userId:", userId);
    Logger.debug("sessionId:", sessionId);
    // get session carts without current user cart cursor
    const sessionCarts = getSessionCarts(userId, sessionId, shopId);

    Logger.debug(
      `merge cart: begin merge processing of session ${
        sessionId} into: ${currentCart._id}`
    );
    // loop through session carts and merge into user cart
    sessionCarts.forEach(sessionCart => {
      Logger.debug(
        `merge cart: merge user userId: ${userId}, sessionCart.userId: ${
          sessionCart.userId}, sessionCart id: ${sessionCart._id}`
      );
      // really if we have no items, there's nothing to merge
      if (sessionCart.items) {
        // if currentCart already have a cartWorkflow, we don't need to clean it
        // up completely, just to `coreCheckoutShipping` stage. Also, we will
        // need to recalculate shipping rates
        if (typeof currentCart.workflow === "object" &amp;&amp;
        typeof currentCart.workflow.workflow === "object") {
          if (currentCart.workflow.workflow.length > 2) {
            Meteor.call("workflow/revertCartWorkflow", "coreCheckoutShipping");
            // refresh shipping quotes
            Meteor.call("shipping/updateShipmentQuotes", cartId);
          }
        } else {
          // if user logged in he doesn't need to show `checkoutLogin` step
          Meteor.call("workflow/revertCartWorkflow", "checkoutAddressBook");
        }

        const cartSum = sessionCart.items.concat(currentCart.items);
        const mergedItems = cartSum.reduce((newItems, item) => {
          if (item) {
            const existingItem = newItems.find(cartItem => cartItem.variants._id === item.variants._id);
            if (existingItem) {
              existingItem.quantity += item.quantity;
            } else {
              newItems.push(item);
            }
          }
          return newItems;
        }, []);
        Collections.Cart.update(currentCart._id, {
          $push: {
            items: { $each: mergedItems, $slice: -(mergedItems.length) }
          }
        });
      }

      // cleanup session Carts after merge.
      if (sessionCart.userId !== this.userId) {
        // clear the cart that was used for a session
        // and we're also going to do some garbage Collection
        Collections.Cart.remove(sessionCart._id);
        // cleanup user/accounts
        Collections.Accounts.remove({
          userId: sessionCart.userId
        });
        Meteor.users.remove(sessionCart.userId);
        Logger.debug(
          `merge cart: delete cart ${
            sessionCart._id} and user: ${sessionCart.userId}`
        );
      }
      Logger.debug(
        `merge cart: processed merge for cartId ${sessionCart._id}`
      );
    });

    // `checkoutLogin` should be used for anonymous only. Registered users
    // no need see this.
    if (currentCart.workflow.status === "new") {
      // to call `workflow/pushCartWorkflow` two times is the only way to move
      // from status "new" to "checkoutAddressBook" which I found without
      // refactoring of `workflow/pushCartWorkflow`
      // We send `cartId` as arguments because this method could be called from
      // publication method and in half cases it could be so, that
      // Meteor.userId() will be null.
      Meteor.call("workflow/pushCartWorkflow", "coreCartWorkflow",
        "checkoutLogin", cartId);
      Meteor.call("workflow/pushCartWorkflow", "coreCartWorkflow",
        "checkoutAddressBook", cartId);
    }

    return currentCart._id;
  },

  /**
   * @method cart/createCart
   * @description create new cart for user,
   * but all checks for current cart's existence should go before this method will be called, to keep it clean
   * @summary create and return new cart for user
   * @memberof Meteor/Cart
   * @param {String} userId - userId to create cart for
   * @param {String} sessionId - current client session id
   * @todo I think this method should be moved out from methods to a Function Declaration to keep it more secure
   * @returns {String} cartId - users cartId
   */
  "cart/createCart": function (userId, sessionId) {
    check(userId, String);
    check(sessionId, String);

    const marketplaceSettings = Reaction.getMarketplaceSettings();
    let shopId;
    if (marketplaceSettings &amp;&amp; marketplaceSettings.public &amp;&amp; marketplaceSettings.public.merchantCart) {
      shopId = Reaction.getShopId();
    } else {
      shopId = Reaction.getPrimaryShopId();
    }

    // check if user has `anonymous` role.( this is a visitor)
    const anonymousUser = Roles.userIsInRole(userId, "anonymous", shopId);
    const sessionCartCount = getSessionCarts(userId, sessionId, shopId).length;

    Logger.debug("create cart: shopId", shopId);
    Logger.debug("create cart: userId", userId);
    Logger.debug("create cart: sessionId", sessionId);
    Logger.debug("create cart: sessionCarts.count", sessionCartCount);
    Logger.debug("create cart: anonymousUser", anonymousUser);

    // we need to create a user cart for the new authenticated user or
    // anonymous.
    const currentCartId = Collections.Cart.insert({
      sessionId: sessionId,
      userId: userId
    });
    Logger.debug("create cart: into new user cart. created: " +  currentCartId +
      " for user " + userId);

    // merge session carts into the current cart
    if (sessionCartCount > 0 &amp;&amp; !anonymousUser) {
      Logger.debug("create cart: found existing cart. merge into " + currentCartId
        + " for user " + userId);
      Meteor.call("cart/mergeCart", currentCartId, sessionId);
    }

    // we should check for an default billing/shipping address in user account.
    // this needed after submitting order, when user receives new cart
    const account = Collections.Accounts.findOne(userId);
    if (account &amp;&amp; account.profile &amp;&amp; account.profile.addressBook) {
      account.profile.addressBook.forEach(address => {
        if (address.isBillingDefault) {
          Meteor.call("cart/setPaymentAddress", currentCartId, address);
        }
        if (address.isShippingDefault) {
          Meteor.call("cart/setShipmentAddress", currentCartId, address);
        }
      });
    }

    // attach current user currency to cart
    const currentUser = Meteor.user();
    let userCurrency = Reaction.getShopCurrency();

    // Check to see if the user has a custom currency saved to their profile
    // Use it if they do
    if (currentUser &amp;&amp; currentUser.profile &amp;&amp; currentUser.profile.currency) {
      userCurrency = currentUser.profile.currency;
    }
    Meteor.call("cart/setUserCurrency", currentCartId, userCurrency);

    return currentCartId;
  },

  /**
   *  @method cart/addToCart
   *  @summary add items to a user cart
   *  @description when we add an item to the cart,
   *  we want to break all relationships with the existing item.
   *  We want to fix price, qty, etc into history
   *  however, we could check reactively for price /qty etc, adjustments on the original and notify them
   *  @memberof Meteor/Cart
   *  @param {String} productId - productId to add to Cart
   *  @param {String} variantId - product variant _id
   *  @param {Number} [itemQty] - qty to add to cart
   *  @param {Object} [additionalOptions] - object containing additional options and fields for cart item
   *  @return {Number|Object} Mongo insert response
   */
  "cart/addToCart": function (productId, variantId, itemQty, additionalOptions) {
    check(productId, String);
    check(variantId, String);
    check(itemQty, Match.Optional(Number));
    check(additionalOptions, Match.Optional(Object));

    // Copy additionalOptions into an options object to use througout the method
    const options = {
      overwriteExistingMetafields: false, // Allows updating of metafields on quantity change
      metafields: undefined, // Array of MetaFields to set on the CartItem
      ...additionalOptions || {}
    };

    const cart = Collections.Cart.findOne({ userId: this.userId });
    if (!cart) {
      Logger.error(`Cart not found for user: ${ this.userId }`);
      throw new Meteor.Error(404, "Cart not found",
        "Cart not found for user with such id");
    }
    // With the flattened model we no longer need to work directly with the
    // products. But product still could be necessary for a `quantityProcessing`
    // TODO: need to understand: do we really need product inside
    // `quantityProcessing`?
    let product;
    let variant;
    Collections.Products.find({ _id: { $in: [
      productId,
      variantId
    ] } }).forEach(doc => {
      if (doc.type === "simple") {
        product = doc;
      } else {
        variant = doc;
      }
    });

    // TODO: this lines still needed. We could uncomment them in future if
    // decide to not completely remove product data from this method
    // const product = Collections.Products.findOne(productId);
    // const variant = Collections.Products.findOne(variantId);
    if (!product) {
      Logger.warn(`Product: ${ productId } was not found in database`);
      throw new Meteor.Error(404, "Product not found",
        "Product with such id was not found!");
    }
    if (!variant) {
      Logger.warn(`Product variant: ${ variantId } was not found in database`);
      throw new Meteor.Error(404, "ProductVariant not found",
        "ProductVariant with such id was not found!");
    }
    // performs calculations admissibility of adding product to cart
    const quantity = quantityProcessing(product, variant, itemQty);
    // performs search of variant inside cart
    const cartVariantExists = cart.items &amp;&amp; cart.items
      .some(item => item.variants._id === variantId);

    if (cartVariantExists) {
      let modifier = {};

      // Allows for updating metafields on an existing item when the quantity also changes
      if (options.overwriteExistingMetafields) {
        modifier = {
          $set: {
            "items.$.metafields": options.metafields
          }
        };
      }

      return Collections.Cart.update({
        "_id": cart._id,
        "items.product._id": productId,
        "items.variants._id": variantId
      }, {
        $inc: {
          "items.$.quantity": quantity
        },
        ...modifier
      }, function (error, result) {
        if (error) {
          Logger.warn("error adding to cart",
            Collections.Cart.simpleSchema().namedContext().invalidKeys());
          return error;
        }

        // refresh shipping quotes
        Meteor.call("shipping/updateShipmentQuotes", cart._id);
        // revert workflow to checkout shipping step.
        Meteor.call("workflow/revertCartWorkflow", "coreCheckoutShipping");
        // reset selected shipment method
        Meteor.call("cart/resetShipmentMethod", cart._id);

        Logger.debug(`cart: increment variant ${variantId} quantity by ${
          quantity}`);

        return result;
      });
    }

    // TODO: Handle more than 2 levels of variant hierarchy for determining parcel dimensions
    // we need to get the parent of the option to check if parcel info is stored there
    const immediateAncestors = variant.ancestors.filter((ancestor) => ancestor !== product._id);
    const immediateAncestor = Collections.Products.findOne({ _id: immediateAncestors[0] });
    let parcel = null;
    if (immediateAncestor) {
      if (immediateAncestor.weight || immediateAncestor.height || immediateAncestor.width || immediateAncestor.length) {
        parcel = { weight: immediateAncestor.weight, height: immediateAncestor.height, width: immediateAncestor.width, length: immediateAncestor.length };
      }
    }
    // if it's set at the option level then that overrides
    if (variant.weight || variant.height || variant.width || variant.length) {
      parcel = { weight: variant.weight, height: variant.height, width: variant.width, length: variant.length };
    }
    // cart variant doesn't exist
    return Collections.Cart.update({
      _id: cart._id
    }, {
      $addToSet: {
        items: {
          _id: Random.id(),
          shopId: product.shopId,
          productId: productId,
          quantity: quantity,
          product: product,
          variants: variant,
          metafields: options.metafields,
          title: product.title,
          type: product.type,
          parcel
        }
      }
    }, function (error, result) {
      if (error) {
        Logger.error(error);
        Logger.error(Collections.Cart.simpleSchema().namedContext().invalidKeys(),
          "Invalid keys. Error adding to cart.");
        return error;
      }

      // refresh shipping quotes
      Meteor.call("shipping/updateShipmentQuotes", cart._id);
      // revert workflow to checkout shipping step.
      Meteor.call("workflow/revertCartWorkflow", "coreCheckoutShipping");
      // reset selected shipment method
      Meteor.call("cart/resetShipmentMethod", cart._id);

      Logger.debug(`cart: add variant ${variantId} to cartId ${cart._id}`);

      return result;
    });
  },

  /**
   * @method cart/removeFromCart
   * @memberof Meteor/Cart
   * @summary removes or adjust quantity of a variant from the cart
   * @param {String} itemId - cart item _id
   * @param {Number} [quantity] - if provided will adjust increment by quantity
   * @returns {Number} returns Mongo update result
   */
  "cart/removeFromCart": function (itemId, quantity) {
    check(itemId, String);
    check(quantity, Match.Optional(Number));

    const userId = Meteor.userId();
    const cart = Collections.Cart.findOne({
      userId: userId
    });
    if (!cart) {
      Logger.error(`Cart not found for user: ${this.userId}`);
      throw new Meteor.Error("cart-not-found", "Cart not found for user with such id");
    }

    let cartItem;

    if (cart.items) {
      cartItem = _.find(cart.items, (item) => item._id === itemId);
    }

    // extra check of item exists
    if (typeof cartItem !== "object") {
      Logger.error(`Unable to find an item: ${itemId} within the cart: ${cart._id}`);
      throw new Meteor.Error("cart-item-not-found", "Unable to find an item with such id in cart.");
    }

    if (!quantity || quantity >= cartItem.quantity) {
      const cartResult = Collections.Cart.update({
        _id: cart._id
      }, {
        $pull: {
          items: {
            _id: itemId
          }
        }
      }, {
        getAutoValues: false // See https://github.com/aldeed/meteor-collection2/issues/245
      }, (error, result) => {
        if (error) {
          Logger.error(error);
          Logger.error(Collections.Cart.simpleSchema().namedContext().invalidKeys(), "error removing from cart");
          return error;
        }
        Logger.debug(`cart: deleted cart item variant id ${cartItem.variants._id}`);
        return result;
      });
      // TODO: HACK: When calling update shipping the changes to the cart have not taken place yet
      // TODO: But calling this findOne seems to force this record to update. Extra weird since we aren't
      // TODO: passing the Cart but just the cartId and regrabbing it so you would think that would work but it does not
      Collections.Cart.findOne(cart._id);
      // refresh shipping quotes
      Meteor.call("shipping/updateShipmentQuotes", cart._id);
      // revert workflow
      Meteor.call("workflow/revertCartWorkflow", "coreCheckoutShipping");
      // reset selected shipment method
      Meteor.call("cart/resetShipmentMethod", cart._id);
      return cartResult;
    }

    // if quantity lets convert to negative and increment
    const removeQuantity = Math.abs(quantity) * -1;
    const cartResult = Collections.Cart.update({
      "_id": cart._id,
      "items._id": cartItem._id
    }, {
      $inc: {
        "items.$.quantity": removeQuantity
      }
    }, (error, result) => {
      if (error) {
        Logger.error(error);
        Logger.error(Collections.Cart.simpleSchema().namedContext().invalidKeys(),
          "error removing from cart");
        return error;
      }
      Logger.debug(`cart: removed variant ${cartItem._id} quantity of ${quantity}`);
      return result;
    });
    // refresh shipping quotes
    Meteor.call("shipping/updateShipmentQuotes", cart._id);
    // revert workflow
    Meteor.call("workflow/revertCartWorkflow", "coreCheckoutShipping");
    // reset selected shipment method
    Meteor.call("cart/resetShipmentMethod", cart._id);
    return cartResult;
  },

  /**
   * @method cart/setShipmentMethod
   * @memberof Meteor/Cart
   * @summary saves method as order default
   * @param {String} cartId - cartId to apply shipmentMethod
   * @param {Object} method - shipmentMethod object
   * @return {Number} return Mongo update result
   */
  "cart/setShipmentMethod": function (cartId, method) {
    check(cartId, String);
    check(method, Object);
    // get current cart
    const cart = Collections.Cart.findOne({
      _id: cartId,
      userId: Meteor.userId()
    });
    if (!cart) {
      Logger.error(`Cart not found for user: ${ this.userId }`);
      throw new Meteor.Error(404, "Cart not found",
        "Cart not found for user with such id");
    }

    // Sets all shipping methods to the one selected
    // TODO: Accept an object of shopId to method map to ship via different methods per shop
    let selector;
    let update;
    // if we have an existing item update it, otherwise add to set.
    if (cart.shipping) {
      const updatedShipping = [];
      cart.shipping.map((shipRecord) => {
        shipRecord.shipmentMethod = method;
        updatedShipping.push(shipRecord);
      });

      selector = {
        _id: cartId
      };
      update = {
        $set: {
          shipping: updatedShipping
        }
      };
    } else {
      selector = {
        _id: cartId
      };
      update = {
        $addToSet: {
          shipping: {
            shipmentMethod: method,
            shopId: cart.shopId
          }
        }
      };
    }

    // update or insert method
    try {
      Collections.Cart.update(selector, update);
    } catch (e) {
      Logger.error(e, `Error adding rates to cart ${cartId}`);
      throw new Meteor.Error("An error occurred saving the order", e);
    }

    // this will transition to review
    return Meteor.call("workflow/pushCartWorkflow", "coreCartWorkflow",
      "coreCheckoutShipping");
  },

  /**
   * @method cart/setUserCurrency
   * @memberof Meteor/Cart
   * @summary saves user currency in cart, to be paired with order/setCurrencyExhange
   * @param {String} cartId - cartId to apply setUserCurrency
   * @param {String} userCurrency - userCurrency to set to cart
   * @return {Number} update result
   */
  "cart/setUserCurrency": function (cartId, userCurrency) {
    check(cartId, String);
    check(userCurrency, String);
    const cart = Collections.Cart.findOne({
      _id: cartId
    });
    if (!cart) {
      Logger.error(`Cart not found for user: ${ this.userId }`);
      throw new Meteor.Error("Cart not found for user with such id");
    }

    const userCurrencyString = {
      userCurrency: userCurrency
    };

    let selector;
    let update;

    if (cart.billing) {
      selector = {
        "_id": cartId,
        "billing._id": cart.billing[0]._id
      };
      update = {
        $set: {
          "billing.$.currency": userCurrencyString
        }
      };
    } else {
      selector = {
        _id: cartId
      };
      update = {
        $addToSet: {
          billing: {
            currency: userCurrencyString
          }
        }
      };
    }

    // add / or set the shipping address
    try {
      Collections.Cart.update(selector, update);
    } catch (e) {
      Logger.error(e);
      throw new Meteor.Error("An error occurred adding the currency");
    }

    return true;
  },

  /**
   * @method cart/resetShipmentMethod
   * @memberof Meteor/Cart
   * @summary removes `shipmentMethod` object from cart
   * @param {String} cartId - cart _id
   * @return {Number} update result
   */
  "cart/resetShipmentMethod": function (cartId) {
    check(cartId, String);

    const cart = Collections.Cart.findOne({
      _id: cartId,
      userId: this.userId
    });
    if (!cart) {
      Logger.error(`Cart not found for user: ${this.userId}`);
      throw new Meteor.Error(404, "Cart not found",
        `Cart: ${cartId} not found for user: ${this.userId}`);
    }

    return Collections.Cart.update({ _id: cartId }, {
      $unset: { "shipping.0.shipmentMethod": "" }
    });
  },

  /**
   * @method cart/setShipmentAddress
   * @memberof Meteor/Cart
   * @summary adds address book to cart shipping
   * @param {String} cartId - cartId to apply shipmentMethod
   * @param {Object} address - addressBook object
   * @return {Number} update result
   */
  "cart/setShipmentAddress": function (cartId, address) {
    check(cartId, String);
    check(address, Reaction.Schemas.Address);

    const cart = Collections.Cart.findOne({
      _id: cartId,
      userId: this.userId
    });
    if (!cart) {
      Logger.error(`Cart not found for user: ${ this.userId }`);
      throw new Meteor.Error(404, "Cart not found",
        "Cart not found for user with such id");
    }
    // TODO: When we have a front end for doing more than one address
    // TODO: we need to not use the same address for every record
    // TODO: this is a temporary workaround so that we have a valid address
    // TODO: for every shipping record
    let selector;
    let update;
    let updated = false; // if we update inline set to true, otherwise fault to update at the end
    // We have two behaviors depending on if we have existing shipping records and if we
    // have items in the cart.
    if (cart.shipping &amp;&amp; cart.shipping.length > 0 &amp;&amp; cart.items) {
      // if we have shipping records and cart.items, update each one by shop
      const shopIds = Object.keys(cart.getItemsByShop());
      shopIds.forEach((shopId) => {
        selector = {
          "_id": cartId,
          "shipping.shopId": shopId
        };

        update = {
          $set: {
            "shipping.$.address": address
          }
        };
        try {
          Collections.Cart.update(selector, update);
          updated = true;
        } catch (error) {
          Logger.error("An error occurred adding the address", error);
          throw new Meteor.Error("An error occurred adding the address", error);
        }
      });
    } else {
      // if no items in cart just add or modify one record for the carts shop
      if (!cart.items) {
        // add a shipping record if it doesn't exist
        if (!cart.shipping) {
          selector = {
            _id: cartId
          };
          update = {
            $push: {
              shipping: {
                address: address,
                shopId: cart.shopId
              }
            }
          };

          try {
            Collections.Cart.update(selector, update);
            updated = true;
          } catch (error) {
            Logger.error(error);
            throw new Meteor.Error("An error occurred adding the address");
          }
        } else {
          // modify an existing record if we have one already
          selector = {
            "_id": cartId,
            "shipping.shopId": cart.shopId
          };

          update = {
            $set: {
              "shipping.$.address": address
            }
          };
        }
      } else {
        // if we have items in the cart but we didn't have existing shipping records
        // add a record for each shop that's represented in the items
        const shopIds = Object.keys(cart.getItemsByShop());
        shopIds.map((shopId) => {
          selector = {
            _id: cartId
          };
          update = {
            $addToSet: {
              shipping: {
                address: address,
                shopId: shopId
              }
            }
          };
        });
      }
    }
    if (!updated) {
      // if we didn't do one of the inline updates, then run the update here
      try {
        Collections.Cart.update(selector, update);
      } catch (error) {
        Logger.error(error);
        throw new Meteor.Error("An error occurred adding the address");
      }
    }
    // refresh shipping quotes
    Meteor.call("shipping/updateShipmentQuotes", cartId);

    if (typeof cart.workflow !== "object") {
      throw new Meteor.Error(500, "Internal Server Error",
        "Cart workflow object not detected.");
    }

    // ~~it's ok for this to be called multiple times~~
    // call it only once when we at the `checkoutAddressBook` step
    if (typeof cart.workflow.workflow === "object" &amp;&amp;
      cart.workflow.workflow.length &lt; 2) {
      Meteor.call("workflow/pushCartWorkflow", "coreCartWorkflow",
        "coreCheckoutShipping");
    }

    // if we change default address during further steps, we need to revert
    // workflow back to `coreCheckoutShipping` step
    if (typeof cart.workflow.workflow === "object" &amp;&amp;
      cart.workflow.workflow.length > 2) { // "2" index of
      // `coreCheckoutShipping`
      Meteor.call("workflow/revertCartWorkflow", "coreCheckoutShipping");
    }

    return true;
  },

  /**
   * @method cart/setPaymentAddress
   * @memberof Meteor/Cart
   * @summary adds addressbook to cart payments
   * @param {String} cartId - cartId to apply payment address
   * @param {Object} address - addressBook object
   * @todo maybe we need to rename this method to `cart/setBillingAddress`?
   * @return {Number} return Mongo update result
   */
  "cart/setPaymentAddress": function (cartId, address) {
    check(cartId, String);
    check(address, Reaction.Schemas.Address);

    const cart = Collections.Cart.findOne({
      _id: cartId,
      userId: this.userId
    });

    if (!cart) {
      Logger.error(`Cart not found for user: ${ this.userId }`);
      throw new Meteor.Error(404, "Cart not found",
        "Cart not found for user with such id");
    }

    let selector;
    let update;
    // temp hack until we build out multiple billing handlers
    // if we have an existing item update it, otherwise add to set.
    if (Array.isArray(cart.billing) &amp;&amp; cart.billing.length > 0) {
      selector = {
        "_id": cartId,
        "billing._id": cart.billing[0]._id
      };
      update = {
        $set: {
          "billing.$.address": address
        }
      };
    } else {
      selector = {
        _id: cartId
      };
      update = {
        $addToSet: {
          billing: {
            address: address
          }
        }
      };
    }

    return Collections.Cart.update(selector, update);
  },

  /**
   * @method cart/unsetAddresses
   * @summary removes address from cart.
   * @memberof Meteor/Cart
   * @param {String} addressId - address._id
   * @param {String} userId - cart owner _id
   * @param {String} [type] - billing default or shipping default
   * @since 0.10.1
   * @todo check if no more address in cart as shipping, we should reset `cartWorkflow` to second step
   * @return {Number|Object|Boolean} The number of removed documents or
   * errorobject or `false` if we don't need to update cart
   */
  "cart/unsetAddresses": function (addressId, userId, type) {
    check(addressId, String);
    check(userId, String);
    check(type, Match.Optional(String));

    // do we actually need to change anything?
    let needToUpdate = false;
    // we need to revert the workflow after a "shipping" address was removed
    let isShippingDeleting = false;
    const cart = Collections.Cart.findOne({
      userId: userId
    });
    const selector = {
      _id: cart._id
    };
    const update = { $unset: {} };
    // user could turn off the checkbox in address to not to be default, then we
    // receive `type` arg
    if (typeof type === "string") {
      // we assume that the billing/shipping arrays can hold only one element [0]
      if (cart[type] &amp;&amp; typeof cart[type][0].address === "object" &amp;&amp;
        cart[type][0].address._id === addressId) {
        update.$unset[`${type}.0.address`] = "";
        needToUpdate = true;
        isShippingDeleting = type === "shipping";
      }
    } else { // or if we remove address itself, when we run this part we assume
      // that the billing/shipping arrays can hold only one element [0]
      if (cart.billing &amp;&amp; typeof cart.billing[0].address === "object" &amp;&amp;
        cart.billing[0].address._id === addressId) {
        update.$unset["billing.0.address"] = "";
        needToUpdate = true;
      }
      if (cart.shipping &amp;&amp; typeof cart.shipping[0].address === "object" &amp;&amp; cart.shipping[0].address._id === addressId) {
        removeShippingAddresses(cart);
        isShippingDeleting = true;
      }
    }

    if (needToUpdate) {
      try {
        Collections.Cart.update(selector, update);
      } catch (e) {
        Logger.error(e);
        throw new Meteor.Error("Error updating cart");
      }

      if (isShippingDeleting) {
        // if we remove shipping address from cart, we need to revert
        // `cartWorkflow` to the `checkoutAddressBook` step.
        Meteor.call("workflow/revertCartWorkflow", "checkoutAddressBook");
      }
    }
    return true;
  },

  /**
   * @method cart/submitPayment
   * @memberof Meteor/Cart
   * @summary saves a submitted payment to cart, triggers workflow and adds "paymentSubmitted" to cart workflow
   * @description Note: this method also has a client stub, that forwards to cartCompleted
   * @param {Object|Array} paymentMethods - an array of paymentMethods or (deprecated) a single paymentMethod object
   * @return {String} returns update result
   */
  "cart/submitPayment": function (paymentMethods) {
    if (Array.isArray((paymentMethods))) {
      check(paymentMethods, [Reaction.Schemas.PaymentMethod]);
    } else {
      check(paymentMethods, Reaction.Schemas.PaymentMethod);
    }


    const cart = Collections.Cart.findOne({
      userId: Meteor.userId()
    });

    const cartId = cart._id;

    const cartShipping = cart.getShippingTotal();
    const cartSubTotal = cart.getSubTotal();
    const cartSubtotalByShop = cart.getSubtotalByShop();
    const cartTaxes = cart.getTaxTotal();
    const cartTaxesByShop = cart.getTaxesByShop();
    const cartDiscounts = cart.getDiscounts();
    const cartTotal = cart.getTotal();
    const cartTotalByShop = cart.getTotalByShop();

    // we won't actually close the order at this stage.
    // we'll just update the workflow and billing data where
    // method-hooks can process the workflow update.

    const payments = [];
    let paymentAddress;

    // Find the payment address associated that the user input during the
    // checkout process
    if (Array.isArray(cart.billing) &amp;&amp; cart.billing[0]) {
      paymentAddress = cart.billing[0].address;
    }

    // Payment plugins which have been updated for marketplace are passing an array as paymentMethods
    if (Array.isArray(paymentMethods)) {
      paymentMethods.forEach((paymentMethod) => {
        const shopId = paymentMethod.shopId;
        const invoice = {
          shipping: parseFloat(cartShipping),
          subtotal: parseFloat(cartSubtotalByShop[shopId]),
          taxes: parseFloat(cartTaxesByShop[shopId]),
          discounts: parseFloat(cartDiscounts),
          total: parseFloat(cartTotalByShop[shopId])
        };

        payments.push({
          paymentMethod: paymentMethod,
          invoice: invoice,
          address: paymentAddress,
          shopId: shopId
        });
      });
    } else {
      // Legacy payment integration - transactions are not split by shop
      // Create an invoice based on cart totals.
      const invoice = {
        shipping: cartShipping,
        subtotal: cartSubTotal,
        taxes: cartTaxes,
        discounts: cartDiscounts,
        total: cartTotal
      };

      // Legacy payment plugins are passing in a single paymentMethod object
      payments.push({
        paymentMethod: paymentMethods,
        invoice: invoice,
        address: paymentAddress,
        shopId: Reaction.getPrimaryShopId()
      });
    }

    const selector = {
      _id: cartId
    };

    const update = {
      $set: {
        billing: payments
      }
    };

    try {
      Collections.Cart.update(selector, update);
    } catch (e) {
      Logger.error(e);
      throw new Meteor.Error("An error occurred saving the order");
    }

    return Collections.Cart.findOne(selector);
  },

  /**
   * @method cart/setAnonymousUserEmail
   * @memberof Meteor/Cart
   * @summary assigns email to anonymous user's cart instance
   * @param {Object} userId - current user's Id
   * @param {String} email - email to set for anonymous user's cart instance
   * @return {Number} returns update result
   */
  "cart/setAnonymousUserEmail": function (userId, email) {
    check(userId, String);
    check(email, String);

    const currentUserCart = Collections.Cart.findOne({ userId: userId });
    const cartId = currentUserCart._id;
    let newEmail = "";

    if (!currentUserCart.email) {
      newEmail = email;
    }

    return Collections.Cart.update({ _id: cartId }, { $set: { email: newEmail } });
  }
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
